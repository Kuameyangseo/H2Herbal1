{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.cart') }}">Cart</a></li>
            <li class="breadcrumb-item active">Checkout</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold text-success mb-3">
                <i class="fas fa-credit-card me-2"></i>Checkout
            </h1>
            <p class="lead text-muted">Complete your order securely</p>
        </div>
    </div>

    <form method="POST" id="checkoutForm">
        {{ form.hidden_tag() }}
        
        <div class="row">
            <!-- Shipping Information -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.first_name.label(class="form-label") }}
                                {{ form.first_name(class="form-control") }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.first_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.last_name.label(class="form-label") }}
                                {{ form.last_name(class="form-control") }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.last_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.email.label(class="form-label") }}
                                {{ form.email(class="form-control") }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.email.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.phone.label(class="form-label") }}
                                {{ form.phone(class="form-control") }}
                                {% if form.phone.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.phone.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.address.label(class="form-label") }}
                            {{ form.address(class="form-control", rows="3") }}
                            {% if form.address.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.address.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.city.label(class="form-label") }}
                                {{ form.city(class="form-control") }}
                                {% if form.city.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.city.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.country.label(class="form-label") }}
                                {{ form.country(class="form-control") }}
                                {% if form.country.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.country.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.postal_code.label(class="form-label") }}
                                {{ form.postal_code(class="form-control") }}
                                {% if form.postal_code.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.postal_code.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check payment-option">
                                        <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" checked>
                                        <label class="form-check-label w-100" for="card">
                                            <div class="payment-card text-center p-3 border rounded">
                                                <i class="fas fa-credit-card fa-2x text-primary mb-2"></i>
                                                <div class="fw-bold">Credit/Debit Card</div>
                                                <small class="text-muted">Visa, Mastercard</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check payment-option">
                                        <input class="form-check-input" type="radio" name="payment_method" id="momo" value="momo">
                                        <label class="form-check-label w-100" for="momo">
                                            <div class="payment-card text-center p-3 border rounded">
                                                <i class="fas fa-mobile-alt fa-2x text-success mb-2"></i>
                                                <div class="fw-bold">Mobile Money</div>
                                                <small class="text-muted">MTN, Vodafone, AirtelTigo</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check payment-option">
                                        <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="bank_transfer">
                                        <label class="form-check-label w-100" for="bank_transfer">
                                            <div class="payment-card text-center p-3 border rounded">
                                                <i class="fas fa-university fa-2x text-info mb-2"></i>
                                                <div class="fw-bold">Bank Transfer</div>
                                                <small class="text-muted">Direct bank transfer</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Money Details (Hidden by default) -->
                        <div id="momoDetails" class="mt-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" name="momo_phone" placeholder="0XX XXX XXXX">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Network</label>
                                    <select class="form-select" name="momo_network">
                                        <option value="">Select Network</option>
                                        <option value="mtn">MTN Mobile Money</option>
                                        <option value="vodafone">Vodafone Cash</option>
                                        <option value="airteltigo">AirtelTigo Money</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 2rem;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cart Items -->
                        <div class="order-items mb-3">
                            {% for item in cart_items %}
                            <div class="d-flex align-items-center mb-3">
                                {% set checkout_image = item.product.get_main_image() %}
                                {% if checkout_image.startswith('http') %}
                                    <img src="{{ checkout_image }}"
                                         class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;"
                                         onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&w=50&h=50&fit=crop'">
                                {% else %}
                                    <img src="{{ url_for('static', filename='uploads/' + checkout_image) }}"
                                         class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;"
                                         onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&w=50&h=50&fit=crop'">
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 small">{{ item.product.name }}</h6>
                                    <small class="text-muted">Qty: {{ item.quantity }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="fw-bold">GH₵{{ "%.2f"|format(item.get_total_price()) }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <hr>

                        <!-- Order Totals -->
                        <div class="order-totals">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span>GH₵{{ "%.2f"|format(subtotal) }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping:</span>
                                <span>GH₵{{ "%.2f"|format(shipping_cost) }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tax:</span>
                                <span>GH₵0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong class="text-success fs-5">GH₵{{ "%.2f"|format(total) }}</strong>
                            </div>
                        </div>

                        <!-- Place Order Button -->
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary btn-lg", id="placeOrderBtn") }}
                        </div>

                        <!-- Security Info -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-lock me-1"></i>
                                Your payment information is secure and encrypted
                            </small>
                        </div>

                        <!-- Payment Logos -->
                        <div class="payment-logos mt-3 text-center">
                            <img src="https://img.icons8.com/color/48/000000/visa.png" alt="Visa" style="height: 30px;" class="me-2">
                            <img src="https://img.icons8.com/color/48/000000/mastercard.png" alt="Mastercard" style="height: 30px;" class="me-2">
                            <img src="https://img.icons8.com/color/48/000000/mobile-payment.png" alt="Mobile Money" style="height: 30px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .payment-option .form-check-input {
        display: none;
    }
    
    .payment-option .form-check-input:checked + .form-check-label .payment-card {
        border-color: var(--primary-green) !important;
        background-color: rgba(45, 80, 22, 0.1);
    }
    
    .payment-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .payment-card:hover {
        border-color: var(--primary-green) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .order-items {
        max-height: 300px;
        overflow-y: auto;
    }
    
    @media (max-width: 991px) {
        .sticky-top {
            position: relative !important;
            top: auto !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Payment method selection
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const momoDetails = document.getElementById('momoDetails');
            if (this.value === 'momo') {
                momoDetails.style.display = 'block';
            } else {
                momoDetails.style.display = 'none';
            }
        });
    });

    // Form submission
    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('placeOrderBtn');
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        // Validate mobile money details if selected
        if (paymentMethod === 'momo') {
            const phone = document.querySelector('input[name="momo_phone"]').value;
            const network = document.querySelector('select[name="momo_network"]').value;
            
            if (!phone || !network) {
                e.preventDefault();
                alert('Please provide your mobile money phone number and select your network.');
                return;
            }
        }
        
        // Update button state
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        submitBtn.disabled = true;
    });

    // Auto-fill user information if available
    document.addEventListener('DOMContentLoaded', function() {
        // This would be populated from the backend with user data
        console.log('Checkout page loaded');
    });

    // Real-time form validation
    document.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
</script>
{% endblock %}